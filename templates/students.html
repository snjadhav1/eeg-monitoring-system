<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Students - Bracon EEG Monitoring</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/styles.css') }}">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&family=Orbitron:wght@400;500;700;900&display=swap" rel="stylesheet">
    <style>
        .loading-spinner {
            text-align: center;
            padding: 50px;
            color: #667eea;
            font-size: 18px;
        }
        .error-message {
            background: rgba(239, 68, 68, 0.1);
            border: 1px solid rgba(239, 68, 68, 0.3);
            color: #ef4444;
            padding: 20px;
            border-radius: 10px;
            margin: 20px 0;
            text-align: center;
        }
        .no-students {
            text-align: center;
            padding: 50px;
            color: #888;
            font-size: 18px;
        }
    </style>
</head>
<body>
    <!-- Animated Background -->
    <div class="background-wrapper">
        <div class="neural-network"></div>
        <div class="particles"></div>
        <div class="gradient-orbs"></div>
    </div>

    <!-- Navigation -->
    <nav class="navbar">
        <div class="nav-container">
            <div class="logo">
                <div class="logo-pulse"></div>
                <span class="logo-text">BRACON</span>
                <span class="logo-subtitle">EEG Monitoring</span>
            </div>
            <div class="nav-links">
                <a href="{{ url_for('index') }}" class="nav-link">
                    <span class="nav-icon">üìä</span>
                    Dashboard
                </a>
                <a href="{{ url_for('students_page') }}" class="nav-link active">
                    <span class="nav-icon">üë•</span>
                    Students
                </a>
                <a href="{{ url_for('session_history_page') }}" class="nav-link">
                    <span class="nav-icon">üìú</span>
                    History
                </a>
            </div>
            <div class="nav-actions">
                <button class="notification-btn">
                    <span class="notification-badge">3</span>
                    üîî
                </button>
                <div class="user-avatar">
                    <img src="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='40' height='40'%3E%3Ccircle cx='20' cy='20' r='20' fill='%23667eea'/%3E%3Ctext x='20' y='26' font-size='16' fill='white' text-anchor='middle' font-family='Arial'%3ET%3C/text%3E%3C/svg%3E" alt="User">
                </div>
            </div>
        </div>
    </nav>

    <!-- Main Content -->
    <main class="main-content">
        <!-- Header Section -->
        <section class="header-section">
            <div class="header-content">
                <div class="header-left">
                    <h1 class="page-title">
                        <span class="title-gradient">Student</span> List
                    </h1>
                    <p class="page-subtitle">All registered students in the EEG monitoring system</p>
                </div>
            </div>
        </section>

        <!-- Search Section -->
        <section class="filter-section glass-card">
            <div class="filter-controls-wrapper">
                <div class="search-box">
                    <span class="search-icon">üîç</span>
                    <input type="text" id="studentSearch" placeholder="Search students by name..." onkeyup="filterStudents()">
                </div>
            </div>
        </section>

        <!-- Students List -->
        <section class="students-list-section">
            <div class="students-table-card glass-card">
                <div class="card-title">
                    <h3>üìã All Students (<span id="studentCount">0</span>)</h3>
                </div>
                
                <div id="loadingSpinner" class="loading-spinner">
                    <div>Loading students...</div>
                </div>
                
                <div id="errorMessage" class="error-message" style="display: none;"></div>
                
                <div id="noStudents" class="no-students" style="display: none;">
                    <p>No students registered yet.</p>
                </div>
                
                <div class="students-table-container" id="studentsTableWrapper" style="display: none;">
                    <table class="students-table">
                        <thead>
                            <tr>
                                <th>#</th>
                                <th>Name</th>
                                <th>MAC Address</th>
                                <th>Registered Date</th>
                                <th>Total Sessions</th>
                                <th>Last Active</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="studentsTableBody">
                            <!-- Students will be dynamically inserted here -->
                        </tbody>
                    </table>
                </div>
            </div>
        </section>
    </main>

    <script src="{{ url_for('static', filename='js/script.js') }}"></script>
    <script>
        let allStudents = [];

        // Format date helper function
        function formatDate(dateString) {
            if (!dateString || dateString === 'Never' || dateString === null) {
                return '<span style="color: #888;">Never</span>';
            }
            
            try {
                const date = new Date(dateString);
                
                // Check if valid date
                if (isNaN(date.getTime())) {
                    return '<span style="color: #888;">Never</span>';
                }
                
                const now = new Date();
                const diffTime = Math.abs(now - date);
                const diffDays = Math.floor(diffTime / (1000 * 60 * 60 * 24));
                
                // For recent dates (last 7 days), show relative time
                if (diffDays === 0) {
                    const diffHours = Math.floor(diffTime / (1000 * 60 * 60));
                    if (diffHours === 0) {
                        const diffMins = Math.floor(diffTime / (1000 * 60));
                        return diffMins === 0 ? '<span style="color: #10b981;">Just now</span>' : `<span style="color: #10b981;">${diffMins} mins ago</span>`;
                    }
                    return `<span style="color: #10b981;">${diffHours} hours ago</span>`;
                } else if (diffDays === 1) {
                    return '<span style="color: #f59e0b;">Yesterday</span>';
                } else if (diffDays < 7) {
                    return `<span style="color: #f59e0b;">${diffDays} days ago</span>`;
                } else {
                    // For older dates, show formatted date
                    return date.toLocaleDateString('en-US', { 
                        year: 'numeric', 
                        month: 'short', 
                        day: 'numeric',
                        hour: '2-digit',
                        minute: '2-digit'
                    });
                }
            } catch (e) {
                console.error('Date parsing error:', e, dateString);
                return '<span style="color: #888;">Invalid date</span>';
            }
        }

        // Load students from backend
        async function loadStudents() {
            try {
                const response = await fetch('/api/students-list');
                const data = await response.json();
                
                document.getElementById('loadingSpinner').style.display = 'none';
                
                if (data.status === 'success') {
                    allStudents = data.students;
                    
                    if (allStudents.length === 0) {
                        document.getElementById('noStudents').style.display = 'block';
                        return;
                    }
                    
                    document.getElementById('studentsTableWrapper').style.display = 'block';
                    renderStudentsTable();
                } else {
                    showError(data.msg || 'Failed to load students');
                }
            } catch (error) {
                console.error('Error loading students:', error);
                document.getElementById('loadingSpinner').style.display = 'none';
                showError('Failed to connect to server');
            }
        }

        // Render students table
        function renderStudentsTable() {
            const tbody = document.getElementById('studentsTableBody');
            const studentCount = document.getElementById('studentCount');
            
            tbody.innerHTML = '';
            studentCount.textContent = allStudents.length;

            allStudents.forEach((student, index) => {
                const row = document.createElement('tr');
                row.className = 'student-row';
                row.setAttribute('data-name', student.name.toLowerCase());
                row.setAttribute('data-mac', student.mac_address.toLowerCase());

                row.innerHTML = `
                    <td>${index + 1}</td>
                    <td><strong>${student.name}</strong></td>
                    <td><code>${student.mac_address}</code></td>
                    <td>${formatDate(student.created_at)}</td>
                    <td>${student.total_sessions || 0}</td>
                    <td>${formatDate(student.last_active)}</td>
                    <td>
                        <button class="table-action-btn" onclick="viewStudentDashboard('${student.mac_address}')">
                            üìä View
                        </button>
                    </td>
                `;
                tbody.appendChild(row);
            });
        }

        // Filter students by search
        function filterStudents() {
            const searchTerm = document.getElementById('studentSearch').value.toLowerCase();
            const rows = document.querySelectorAll('.student-row');
            let visibleCount = 0;

            rows.forEach(row => {
                const name = row.getAttribute('data-name');
                const mac = row.getAttribute('data-mac');

                if (name.includes(searchTerm) || mac.includes(searchTerm)) {
                    row.style.display = '';
                    visibleCount++;
                } else {
                    row.style.display = 'none';
                }
            });

            document.getElementById('studentCount').textContent = visibleCount;
        }

        // Show error message
        function showError(message) {
            const errorDiv = document.getElementById('errorMessage');
            errorDiv.textContent = message;
            errorDiv.style.display = 'block';
        }

        // View student dashboard
        function viewStudentDashboard(macAddress) {
            // Find student by MAC address
            const student = allStudents.find(s => s.mac_address === macAddress);
            
            if (student) {
                // Store student info in localStorage
                localStorage.setItem('selectedStudentMac', macAddress);
                localStorage.setItem('selectedStudentName', student.name);
                localStorage.setItem('selectedStudentId', student.id);
                
                // Redirect to dashboard
                window.location.href = '/';
            } else {
                alert('Student not found!');
            }
        }

        // Load students on page load
        document.addEventListener('DOMContentLoaded', loadStudents);
    </script>
</body>
</html>
